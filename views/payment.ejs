<!DOCTYPE html>
<html>
    <head>
        <title>Payments</title>

        <script src="https://checkoutshopper-test.adyen.com/checkoutshopper/sdk/3.21.1/adyen.js" integrity="sha384-qgB03MgLihAbvkTmWIkmZxFUxyAqJ4Ozk1My6beIRqit6+8e5HFg8ysln5y5FSw0" crossorigin="anonymous"></script>
        <!-- Adyen provides the SRI hash that you include as the integrity attribute. Refer to our release notes to get the SRI hash for the specific version. https://docs.adyen.com/online-payments/release-notes -->

        <link rel="stylesheet" href="https://checkoutshopper-test.adyen.com/checkoutshopper/sdk/3.21.1/adyen.css" integrity="sha384-KM3xJKzswGJ0xqiPCOHrWUtn0i0LHqEngauvYxSfy0eRtqcImL7ArxjV2HVgeRJ/" crossorigin="anonymous" />
        <!-- Adyen provides the SRI hash that you include as the integrity attribute. Refer to our release notes to get the SRI hash for the specific version. https://docs.adyen.com/online-payments/release-notes -->


    </head>
    <body>
        <h1 style="text-align:center">Payments Page</h1>
        <div id="dropin-container"></div>
        <div id="component-container"></div>
        <script>



            function handleOnChange(state, component) {
                state.isValid; // True or false. Specifies if all the information that the shopper provided is valid.
                state.data; // Provides the data that you need to pass in the `/payments` call.
                component; // Provides the active component instance that called this event.
            }

            function handleOnAdditionalDetails(state, component) {
                state.data; // Provides the data that you need to pass in the `/payments/details` call.
                component; // Provides the active component instance that called this event.
            }

            let paymentMethodsResponse = {};

            async function handleSubmission(state, component, url) {
                try {
                    console.log(state, url, component);
                    const res = await callServer("/api/initiatePayment", state.data);
                    handleServerResponse(res, component);
                } catch (error) {
                    console.error(error);
                }
            }

            function handleServerResponse(res, component) {
                if (res.action) {
                    component.handleAction(res.action);
                } else {
                    switch (res.resultCode) {
                        case "Authorised":
                            window.location.href = "/result/success";
                            break;
                        case "Pending":
                        case "Received":
                            window.location.href = "/result/pending";
                            break;
                        case "Refused":
                            window.location.href = "/result/failed";
                            break;
                        default:
                            window.location.href = "/result/error";
                            break;
                    }
                }
            }

            async function callServer(url, data) {
                const res = await fetch(url, {
                    method: "POST",
                    body: data ? JSON.stringify(data) : "",
                    headers: {
                        "Content-Type": "application/json",
                    },
                });

                return await res.json();
            }


            function renderPayment() {
                const configuration = {
                    locale: "en_US", // The shopper's locale. For a list of supported locales, see https://docs.adyen.com/online-payments/components-web/localization-components.
                    environment: "test", // When you're ready to accept live payments, change the value to one of our live environments https://docs.adyen.com/online-payments/components-web#testing-your-integration.
                    clientKey: "pub.v2.8115650120946270.aHR0cDovL2xvY2FsaG9zdDo0MDAw.qkW8U0At9rzf7Ywm58Wl1S3FB6YFiHc6OCZbTikX-tE", // Your client key. To find out how to generate one, see https://docs.adyen.com/development-resources/client-side-authentication. Web Components versions before 3.10.1 use originKey instead of clientKey.
                    paymentMethodsResponse: paymentMethodsResponse, // The payment methods response returned in step 1.
                    onChange: handleOnChange, // Your function for handling onChange event
                    onAdditionalDetails: handleOnAdditionalDetails, // Your function for handling onAdditionalDetails event
                    showPayButton: true,
                    onSubmit: handleSubmission,
                };
                console.log(paymentMethodsResponse);

                const checkout = new AdyenCheckout(configuration);
                const card = checkout.create("dropin").mount("#component-container");
            }

            const params = new URLSearchParams(window.location.search);

            const country = params.get("country");

            console.log(country); // "sai"

            fetch("/getPaymentMethod/" + country)
                .then((resp) => resp.json())
                .then(function (data) {
                    console.log(data);
                    paymentMethodsResponse = data;
                    renderPayment();
                })
                .catch(function (error) {
                    console.log(error);
                });
        </script>
    </body>
</html>
